### ç®€ä»‹
vueä»2.xç‰ˆæœ¬å¼€å§‹å¼•å…¥äº†virtual domçš„æ¦‚å¿µï¼Œdiffç®—æ³•çš„å¯¹è±¡å°±æ˜¯è™šæ‹Ÿdomï¼Œæ›´æ–°domå°±æ˜¯diffç®—æ³•çš„ç»“æœï¼Œè™šæ‹Ÿdomå¯ä»¥ç¡®ä¿åªå¯¹ç•Œé¢ä¸ŠçœŸæ­£å˜åŒ–çš„éƒ¨åˆ†è¿›è¡Œå®é™…çš„domæ“ä½œï¼Œvueçš„diffç®—æ³•é›†ä¸­ä½äºpatch.jsæ–‡ä»¶ä¸­ã€‚ç¨åä¼šåœ¨æœ¬æ–‡ä¸­å‘ˆç°patchçš„éƒ¨åˆ†ä»£ç ã€‚
### ä»€ä¹ˆæ˜¯virtual dom
  virtual domä¹Ÿå°±æ˜¯è™šæ‹Ÿdomå¯¹åº”çš„çœŸå®domï¼Œ é€šä¿—æ˜“æ‡‚çš„æ¥è¯´å°±æ˜¯ç”¨ä¸€ä¸ªç®€å•çš„å¯¹è±¡å»ä»£æ›¿å¤æ‚çš„domå¯¹è±¡ï¼Œç„¶åå†æ ¹æ®è¿™ä¸ªå¯¹è±¡æ¥ç”Ÿæˆdomã€‚å½“æˆ‘ä»¬å¤„ç†é¡µé¢é€»è¾‘éœ€è¦é‡æ–°æ¸²æŸ“é¡µé¢çš„æ—¶å€™ï¼Œå‡å¦‚ç›´æ¥ä½¿ç”¨jsæ“ä½œdomï¼Œå¦‚æœå˜åŠ¨çš„èŒƒå›´æ¯”è¾ƒå¤§çš„è¯é‚£å¯¹æ€§èƒ½æ¶ˆè€—ä¹Ÿæ˜¯éå¸¸å¤§çš„ï¼Œæ‰€ä»¥å¼•å…¥virtual domçš„æ¦‚å¿µå°±æ˜¯è§£å†³è¿™ä¸€é—®é¢˜çš„ã€‚
  
  ##### ä¸¾ä¸ªä¾‹å­ï¼š
```
// å½“æˆ‘ä»¬æƒ³ç”Ÿæˆä¸€ä¸ªå¸¦classå±æ€§ä¸ºbtnçš„divå…ƒç´ ï¼Œé€šå¸¸çš„æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š
var domDiv = document.creatElement('div');
domDiv.className = "btn";
document.body.appendChild(domDiv);
// æ— è®ºè¿™ä¸ªå…ƒç´ æ˜¯æ–°å¢çš„è¿˜æ˜¯æ›¿æ¢çš„æˆ–è€…æ˜¯ä»¥å‰å°±å­˜åœ¨çš„ï¼Œéƒ½éœ€è¦é€šè¿‡creatElementå’ŒappendChildè¿™å†™æ–¹æ³•æ¥ç”Ÿæˆå…ƒç´ å¹¶ä¸”æ”¾åˆ°bodyä¸­ï¼Œè¿™æ— å½¢ä¸­å°±å¢åŠ äº†ä¸€å±‚å›ºæœ‰æ¶ˆè€—
```
  å‡å¦‚æˆ‘ä»¬é‡‡ç”¨virtual domçš„æ–¹å¼å¯¹é¡µé¢çš„å…ƒç´ è¿›è¡Œæ›´æ–°çš„æ—¶å€™å°±æ˜¯è¿™æ ·å®ç°çš„ï¼š
```
//æ–°æ—§domå¯¹è±¡
var oldDivVirtual = { 
  tagName: 'DIV',
  className: 'old-btn'
};
var newDivVirtual = {
   tagName: 'DIV',
   className: 'new-btn'
}
// å¯¹æ–°æ—§domå¯¹è±¡çš„å±æ€§åšå¯¹æ¯”ï¼Œæ¥åˆ†ææ˜¯å¦éœ€è¦æ›´æ–°dom
if(oldDivVirtual.tagName !== newDivVirtual.tagName || oldDivVirtual.className  !== newDivVirtual.className){
   changeDom(domDiv)
}
```
virtual domç›¸æ¯”äºä¼ ç»Ÿdomå¤šäº†ä¸€å±‚domå¯¹è±¡çš„å¯¹æ¯”é€»è¾‘ï¼Œæ‰€ä»¥ä¹Ÿå°±æ„å‘³ç€å¾ˆå¤šæ—¶å€™å½“æˆ‘ä»¬ä½œå‡ºæ¯”è¾ƒå°çš„domå˜åŠ¨çš„æ—¶å€™virtual domä¸æ˜¯æœ€ä½³çš„æ–¹æ¡ˆï¼Œå¯èƒ½ç›´æ¥æ“ä½œdomä¼šæ–¹ä¾¿ä¸€äº›ï¼Œä½†å½“é¡µé¢å†…å®¹æ¯”è¾ƒåºå¤§ï¼Œæ›´æ–°èŠ‚ç‚¹æ¯”è¾ƒå¤šçš„æ—¶å€™virtual domå°±ä¼šæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œåªé’ˆå¯¹éœ€è¦æ›¿æ¢çš„domè¿›è¡Œæ“ä½œï¼Œè¿™æ ·å¯ä»¥èŠ‚çœæ€§èƒ½å¼€é”€ã€‚
### virtual domä¸­çš„diffç®—æ³•
  ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬çœ‹åˆ°å…¶ä¸­æœ‰ä¸€å±‚åˆ¤æ–­ï¼Œå³å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹çš„domå¯¹è±¡å±æ€§æ˜¯å¦ç›¸åŒï¼Œå½“èŠ‚ç‚¹ä¸ç›¸åŒçš„æ—¶å€™å°±ä¼šæ‰§è¡ŒchangeDomå‡½æ•°ï¼Œå…¶å®è¿™å±‚é€»è¾‘å°±æ˜¯ä¸€å®šæ„ä¹‰ä¸Šdiffç®—æ³•ï¼Œå½“ç„¶å®é™…ä½¿ç”¨ä¸­çš„diffç®—æ³•æ¯”è¿™ä¸ªå¤æ‚çš„å¤šã€‚
  
  äº†è§£è¿‡reactçš„virtualåº”è¯¥å€¼å¾—ï¼Œdiffç®—æ³•çš„æ¯”è¾ƒåªä¼šåœ¨åŒå±‚çº§è¿›è¡Œ,ä¸ä¼šè·¨å±‚çº§æ¯”è¾ƒï¼ŒåŒæ ·vueä¹Ÿé‡‡ç”¨äº†ç±»ä¼¼çš„æ–¹å¼ã€‚

### å¥‰ä¸Šæºç 
```
//ä¸€ä¸ªvnodeçš„å®Œæ•´å±æ€§
function vnode (tag, data, children, text, elm) {
	this.tag = tag;     // èŠ‚ç‚¹æ ‡ç­¾div
	this.data = data;   // å­˜å‚¨èŠ‚ç‚¹å±æ€§çš„å¯¹è±¡ï¼Œäº‹ä»¶å±æ€§ã€å…ƒç´ æ ·å¼styleç­‰
	this.children = children;   // å­èŠ‚ç‚¹çš„æ•°ç»„
	this.text = text;   // æ–‡æœ¬èŠ‚ç‚¹çš„å†…å®¹ï¼ŒtextContent
	this.elm = elm;     // èŠ‚ç‚¹çš„å¼•ç”¨ï¼ŒçœŸå®domç‚¹
}
```
æŸ¥çœ‹æ•´ä¸ªpatch.jsæ–‡ä»¶ï¼ŒæŠŠä¸€äº›functionçš„ä»£ç éƒ½åˆä¸Šä¹‹åæˆ‘ä»¬ä¸éš¾å‘ç°é¡µé¢æ‰€æœ‰functionçš„çš„å¼•ç”¨éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªpatchæ–¹æ³•ä¸‹å‘ï¼Œå…¶ä¸­patchæ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸ºäº†è¯´çš„æ›´ç›´ç™½å‚æ•°åç§°éƒ½ç®€åŒ–ä¸€ä¸‹å«åšoldVnodeå’ŒnewVnodeã€‚
é™„ä¸Špatchæºç åŠç›¸å…³ä»£ç ï¼š
```
function patch (oldVnode, vnode) {
	var isRealElement = oldVnode.nodeType !== undefined; // virtual node has no `nodeType` property
	// é€šè¿‡sameVnodeå‡½æ•°å¯¹æ¯”åˆ¤æ–­æ˜¯å¦æ˜¯ç»Ÿä¸€èŠ‚ç‚¹å…·æœ‰å¯å¯¹æ¯”æ€§
	if (!isRealElement && sameVnode(oldVnode, vnode)) {
		patchVnode(oldVnode, vnode);
	} else {
	// å¦‚æœä¸æ˜¯åŒä¸€èŠ‚ç‚¹ï¼Œå°±æ‰§è¡Œä¸‹é¢çš„é€»è¾‘ï¼Œç”Ÿæˆå…ƒç´ ï¼Œæ’å…¥dom
		if (isRealElement) {
		oldVnode = emptyNodeAt(oldVnode);
		}
		var elm = oldVnode.elm;
		var parent = elm.parentNode;
		
		createElm(vnode);

		parent.insertBefore(vnode.elm, elm);
		parent.removeChild(elm);
	}

	return vnode.elm;
}

function sameVnode (vnode1, vnode2) {
	return vnode1.tag === vnode2.tag
}
// ç”¨æ¥ç”Ÿæˆæ ‡ç­¾å…ƒç´ çš„å±æ€§
function emptyNodeAt (elm) {
	return new vnode(elm.tagName.toLowerCase(), {}, [], undefined, elm)
}
// é‡ç‚¹ç®—æ³•ï¼Œå½“ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯åŒä¸€çº§åˆ«å³å€¼å¾—æ¯”è¾ƒçš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡ŒpatchVnodeå‡½æ•°ï¼Œé’ˆå¯¹èŠ‚ç‚¹çš„å±æ€§ä»¥åŠå­èŠ‚ç‚¹ç­‰ä¿¡æ¯è¿›è¡Œå¯¹æ¯”åˆ†æ
function patchVnode (oldVnode, vnode) {
	var elm = vnode.elm = oldVnode.elm;
	var oldCh = oldVnode.children;
	var ch = vnode.children;

	if (!vnode.text) {
		if (oldCh && ch) {
	// èŠ‚ç‚¹é‡ŒåŒ…å«å­èŠ‚ç‚¹ï¼Œå¯¹å­èŠ‚ç‚¹è¿›è¡Œå¤„ç†
		updateChildren(oldCh, ch);
		}
	} else if (oldVnode.text !== vnode.text) {
	// èŠ‚ç‚¹é‡Œæ˜¯æ–‡æœ¬å†…å®¹
		elm.textContent = vnode.text;
	}
}
```
ä¸€ä¸ªpatchè¿‡ç¨‹æ€»ç»“æ¥è¯´å°±æ˜¯å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹ï¼Œå¦‚æœä¸¤ä¸ªèŠ‚ç‚¹æ˜¯åŒä¸€çº§åˆ«ï¼Œæ‰§è¡ŒpathcVnodeæ–¹æ³•ï¼Œè¿›è¡Œè¯¦ç»†å¯¹æ¯”åˆ†æï¼Œå¦‚æœä¸æ˜¯åŒä¸€çº§åˆ«çš„æˆ–è€…ä¸æ˜¯åŒä¸€å…ƒç´ ï¼Œåˆ™ç”Ÿæˆæ–°çš„å…ƒç´ æ’å…¥domä¸­ï¼Œå½“ç„¶è¿™æ˜¯ä»£ç ç®€åŒ–ä¹‹åçš„æ ·å­ï¼Œé‡Œé¢æœ‰éƒ¨åˆ†é€»è¾‘è¢«æˆ‘åˆ é™¤äº†ï¼ˆğŸ˜‚ï¼‰ã€‚
```
// å½“å¯¹ä¸€ä¸ªå­èŠ‚ç‚¹è¿›è¡Œå¤„ç†æ—¶
function updateChildren (parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly) {
	var oldStartIdx = 0;
	var newStartIdx = 0;
	var oldEndIdx = oldCh.length - 1;
	var oldStartVnode = oldCh[0];
	var oldEndVnode = oldCh[oldEndIdx];
	var newEndIdx = newCh.length - 1;
	var newStartVnode = newCh[0];
	var newEndVnode = newCh[newEndIdx];
	var oldKeyToIdx, idxInOld, vnodeToMove, refElm;

	// removeOnly is a special flag used only by <transition-group>
	// to ensure removed elements stay in correct relative positions
	// during leaving transitions
	var canMove = !removeOnly;

	while (oldStartIdx <= oldEndIdx && newStartIdx <= newEndIdx) {
		if (isUndef(oldStartVnode)) {
		oldStartVnode = oldCh[++oldStartIdx]; // Vnode has been moved left
		} else if (isUndef(oldEndVnode)) {
		oldEndVnode = oldCh[--oldEndIdx];
		} else if (sameVnode(oldStartVnode, newStartVnode)) {
		patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue);
		oldStartVnode = oldCh[++oldStartIdx];
		newStartVnode = newCh[++newStartIdx];
		} else if (sameVnode(oldEndVnode, newEndVnode)) {
		patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue);
		oldEndVnode = oldCh[--oldEndIdx];
		newEndVnode = newCh[--newEndIdx];
		} else if (sameVnode(oldStartVnode, newEndVnode)) { // Vnode moved right
		patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue);
		canMove && nodeOps.insertBefore(parentElm, oldStartVnode.elm, nodeOps.nextSibling(oldEndVnode.elm));
		oldStartVnode = oldCh[++oldStartIdx];
		newEndVnode = newCh[--newEndIdx];
		} else if (sameVnode(oldEndVnode, newStartVnode)) { // Vnode moved left
		patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue);
		canMove && nodeOps.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm);
		oldEndVnode = oldCh[--oldEndIdx];
		newStartVnode = newCh[++newStartIdx];
		} else {
		if (isUndef(oldKeyToIdx)) { oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx); }
		idxInOld = isDef(newStartVnode.key)
			? oldKeyToIdx[newStartVnode.key]
			: findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx);
		if (isUndef(idxInOld)) { // New element
			createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm);
		} else {
			vnodeToMove = oldCh[idxInOld];
			/* istanbul ignore if */
			if ("development" !== 'production' && !vnodeToMove) {
			warn(
				'It seems there are duplicate keys that is causing an update error. ' +
				'Make sure each v-for item has a unique key.'
			);
			}
			if (sameVnode(vnodeToMove, newStartVnode)) {
			patchVnode(vnodeToMove, newStartVnode, insertedVnodeQueue);
			oldCh[idxInOld] = undefined;
			canMove && nodeOps.insertBefore(parentElm, vnodeToMove.elm, oldStartVnode.elm);
			} else {
			// same key but different element. treat as new element
			createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm);
			}
		}
		newStartVnode = newCh[++newStartIdx];
		}
	}
	if (oldStartIdx > oldEndIdx) {
		refElm = isUndef(newCh[newEndIdx + 1]) ? null : newCh[newEndIdx + 1].elm;
		addVnodes(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue);
	} else if (newStartIdx > newEndIdx) {
		removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx);
	}
}
// ä¸ºäº†è¯´æ˜å¯¹æ¯”çš„é—®é¢˜ï¼Œé™„ä¸Šå®Œæ•´çš„sameVnodeä»£ç 
function sameVnode (a, b) {
	return (
	a.key === b.key && (
		(
		a.tag === b.tag &&
		a.isComment === b.isComment &&
		isDef(a.data) === isDef(b.data) &&
		sameInputType(a, b)
		) || (
		isTrue(a.isAsyncPlaceholder) &&
		a.asyncFactory === b.asyncFactory &&
		isUndef(b.asyncFactory.error)
		)
	)
	)
}
```
updateChildrenå‡½æ•°æ˜¯æ•´ä¸ªdiffç®—æ³•çš„æ ¸å¿ƒï¼Œç”±å®ƒé‡Œé¢çš„é€»è¾‘æ¥å¤„ç†åˆ†ææ•´ä¸ªæ–°çš„domã€‚ç”±äºå’±ä»¬è¿™ç¯‡æ–‡ç« æ˜¯æµ…è°ˆï¼Œæ‰€ä»¥ä¸Šé¢çš„é€»è¾‘ä»£ç ä¹Ÿæ˜¯åšä¸€ä¸ªç®€è¦æ€»ç»“ï¼šæ–°æ—§ä¸¤ä¸ªdomçš„å­èŠ‚ç‚¹å„æœ‰é¦–å°¾ä¸¤ä¸ªç´¢å¼•å˜é‡ï¼šnewStartIdxï¼ŒnewEndIdxï¼ŒoldStartIdx ï¼ŒoldEndIdxã€‚ç„¶åé€šè¿‡æ–°æ—§ä¸¤ä¸ªç´¢å¼•å˜é‡å¯¹åº”çš„èŠ‚ç‚¹è¿›è¡Œç›¸äº’æ¯”è¾ƒï¼Œä¸€å…±æœ‰4ç§æ¯”è¾ƒæ–¹æ³•ã€‚å…·ä½“åŒ¹é…å†…å®¹è¯¦æƒ…å‚è€ƒsameVnodeå‡½æ•°ã€‚å½“æœ‰åŒ¹é…çš„åˆ°ç›¸åŒçš„å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯newStartIdxæˆ–è€…oldStartIdxåŒ¹é…åˆ°ï¼Œåˆ™newStartIdxæˆ–è€…oldStartIdxç›¸åº”åŠ 1ï¼ŒåŒç†oldStartIdxå’ŒoldEndIdxç›¸åº”å‡1ï¼Œè¿™æ ·å¼€å§‹çš„ç´¢å¼•å’Œç»“æŸçš„ç´¢å¼•éƒ½ä¼šæ ¹æ®åŒ¹é…çš„æƒ…å†µå¯¹åº”çš„åŠ å‡1ï¼Œå½“æ–°èŠ‚ç‚¹é‡Œé¢æœ‰çš„æ ‡ç­¾æ˜¯æ—§èŠ‚ç‚¹é‡Œé¢æ²¡æœ‰çš„è¯ï¼Œåˆ™æ‰§è¡Œæœ€ä¸‹é¢çš„åˆ›å»ºæ ‡ç­¾é€»è¾‘ï¼ŒnewStartIdxä¹Ÿä¼šå¯¹åº”åŠ 1ï¼Œç„¶åæ— è®ºæ–°æ—§èŠ‚ç‚¹ï¼Œå½“ä»–ä»¬çš„å¼€å§‹çš„ç´¢å¼•å¤§äºç»“æŸçš„ç´¢å¼•æ—¶ï¼Œè¯´æ˜è¿™ä¸ªdomçš„æ‰€æœ‰å­èŠ‚ç‚¹å…¨éƒ¨å¾ªç¯å®Œï¼Œå³å¦‚æœæ˜¯æ–°çš„domèŠ‚ç‚¹å¾ªç¯å®Œï¼Œåˆ™åˆ é™¤æ‰€æœ‰æ—§èŠ‚ç‚¹çš„å‰©ä½™å­èŠ‚ç‚¹ï¼Œåä¹‹åˆ™åˆ›å»ºå¹¶æ·»åŠ æ‰€æœ‰æ–°çš„domèŠ‚ç‚¹çš„å‰©ä½™å­èŠ‚ç‚¹ã€‚è‡³æ­¤æ•´ä¸ªdomçš„æ›´æ–°æµç¨‹èµ°å®Œã€‚
  
  
  